@page "/"
@using AntDesign.Charts
@inject WordService WordService
@inject NavigationManager Navigation

<PageTitle>单词学习仪表盘</PageTitle>

<Row Gutter="16">
    <Col Span="8">
        <Card>
            <Statistic Title="总词汇量" Value="@WordService.AllWords.Count" PrefixTemplate="@((RenderFragment)(builder => builder.AddContent(0, ((MarkupString)"<span role='img' aria-label='book' class='anticon anticon-book'><svg viewBox='64 64 896 896' focusable='false' data-icon='book' width='1em' height='1em' fill='currentColor' aria-hidden='true'><path d='M832 64H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-260 72h96v209.9L621.5 312 572 347.4V136zm220 752H232V136h280v296.9c0 3.3 1 6.6 3 9.3a15.9 15.9 0 0022.3 3.7l83.8-59.9 81.4 59.4c2.7 2 6 3.1 9.4 3.1 8.8 0 16-7.2 16-16V136h64v752z'></path></svg></span>"))))" />
        </Card>
    </Col>
    <Col Span="8">
        <Card>
            <Statistic Title="已练习单词" Value="@WordService.Stats.WordAttempts.Count" />
        </Card>
    </Col>
    <Col Span="8">
        <Card>
            <Statistic Title="总体正确率" Value="@CalculateAccuracy()" Suffix="%" Precision="2" />
        </Card>
    </Col>
</Row>

<Divider Orientation="@DividerOrientation.Left">快速开始</Divider>

<Row Gutter="16">
    <Col Span="24" Style="text-align: center;">
        <Space Size="@("middle")">
            <SpaceItem>
                <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" OnClick="@(() => Navigation.NavigateTo("/config"))">
                    开始新测试
                </Button>
            </SpaceItem>
            <SpaceItem>
                <Button Type="@ButtonType.Default" Size="@ButtonSize.Large" OnClick="@(() => Navigation.NavigateTo("/stats"))">
                    统计分析
                </Button>
            </SpaceItem>
        </Space>
    </Col>
</Row>

<Divider Orientation="@DividerOrientation.Left">学习曲线</Divider>

<Row>
    <Col Span="24">
        @if (chartData.Any())
        {
            <Line Data="chartData" Config="chartConfig" />
        }
        else
        {
            <div style="text-align: center; padding: 20px;">
                暂无测试记录。开始测试以查看您的进度！
            </div>
        }
    </Col>
</Row>

<Divider Orientation="@DividerOrientation.Left">近期进度</Divider>

<Table DataSource="@WordService.Stats.TestHistory.OrderByDescending(x => x.Date).Take(5)" TItem="TestResult">
    <PropertyColumn Property="c=>c.Date" Format="yyyy-MM-dd HH:mm" Title="日期" />
    <PropertyColumn Property="c=>c.Mode" Title="模式" />
    <PropertyColumn Property="c=>c.CorrectCount" Title="正确数" />
    <PropertyColumn Property="c=>c.TotalQuestions" Title="总题数" />
</Table>

@code {
    private List<object> chartData = new();
    private LineConfig chartConfig = new LineConfig
    {
        Padding = "auto",
        XField = "date",
        YField = "accuracy",
        XAxis = new ValueCatTimeAxis
        {
            TickCount = 5
        },
        Smooth = true
    };

    protected override void OnInitialized()
    {
        PrepareChartData();
    }

    private void PrepareChartData()
    {
        var history = WordService.Stats.TestHistory.OrderBy(x => x.Date).ToList();
        foreach (var result in history)
        {
            double accuracy = result.TotalQuestions == 0 ? 0 : (double)result.CorrectCount / result.TotalQuestions * 100;
            chartData.Add(new
            {
                date = result.Date.ToString("MM-dd HH:mm"),
                accuracy = Math.Round(accuracy, 1)
            });
        }
    }

    private double CalculateAccuracy()
    {
        var totalAttempts = WordService.Stats.WordAttempts.Values.Sum();
        var totalCorrect = WordService.Stats.WordCorrectCounts.Values.Sum();
        if (totalAttempts == 0) return 0;
        return (double)totalCorrect / totalAttempts * 100;
    }
}
